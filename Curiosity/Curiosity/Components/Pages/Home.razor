@page "/"
@using Plugin.BLE
@using Plugin.BLE.Abstractions
@using Plugin.BLE.Abstractions.Contracts
@using Plugin.BLE.Abstractions.Exceptions
@using System.Text.Unicode
@using System.Text
@using System.Net
@using System.Timers

<h1>Curiosityへようこそ!</h1>

@if (Rover != null)
{
    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
        <div>
            <button class="btn btn-secondary" style="width: 100px;" @onmousedown="() => Rover.Move(MotorDirection.Forward)"
                @onmouseleave="() => Rover.Move(MotorDirection.Stop)">前進</button>
        </div>
        <div style="display: flex; flex-direction: row; justify-content: center; gap: 8px;">
            <button class="btn btn-secondary" style="width: 100px;" @onmousedown="() => Rover.Move(MotorDirection.Left)"
                @onmouseleave="() => Rover.Move(MotorDirection.Stop)">左</button>
            <button class="btn btn-danger" style="width: 100px;" @onmousedown="() => Rover.Move(MotorDirection.Stop)"
                @onmouseleave="() => Rover.Move(MotorDirection.Stop)">停止</button>
            <button class="btn btn-secondary" style="width: 100px;" @onmousedown="() => Rover.Move(MotorDirection.Right)"
                @onmouseleave="() => Rover.Move(MotorDirection.Stop)">右</button>
        </div>
        <div>
            <button class="btn btn-secondary" style="width: 100px;" @onmousedown="() => Rover.Move(MotorDirection.Backward)"
                @onmouseleave="() => Rover.Move(MotorDirection.Stop)">後退</button>
        </div>
        <div style="margin-top: 12px;">
            <button class="btn btn-primary" @onclick="APITest">APIリクエスト</button>
        </div>
    </div>
    <hr />
    <img src="@($"data:image/png;base64,{currentImageBase64}")" alt="Rover Camera" style="max-width: 100%; height: auto;" />
    <hr />
    <h3>ローバーの状態</h3>
    <p>稼働時間: @Rover.Data.Uptime 秒</p>
    <p>バッテリー残量: @Rover.Data.BatteryLevel %</p>
    <p>電源電圧: @Rover.Data.Voltage %</p>
    <p>温度: @Rover.Data.Temperature °C</p>
    <p>気圧: @Rover.Data.Pressure hPa</p>
    <p>湿度: @Rover.Data.Humidity %</p>
    <p>距離: @Rover.Data.Distance mm</p>
}
else
{
    <p>ローバーに接続されていません。</p>
}

<p>@rawText</p>

@code {
    string bleState = "Unknown";
    string rawText = "No data received yet.";
    string currentImageBase64 = "";
    Timer timer;
    Rover Rover = new Rover();
    APIClient apiClient = new APIClient("https://curiosity.taiseiue.jp");
    CameraService camera;
    private async Task APITest()
    {
        await camera.CapturePhotoAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        camera = new CameraService();
        camera.PhotoCaptured += async (sender, data) =>
        {
            try
            {
                var result = await apiClient.PostData(Rover.Data, data);
                rawText = $"HTTP {result.StatusCode}: {await result.Content.ReadAsStringAsync()}";
            }
            catch (Exception ex)
            {
                rawText = $"Error: {ex.Message}";
            }
            StateHasChanged();
        };
        await Rover.StartConnect();
        try
        {
            HubClient hub = await HubClient.ConnectAsync("https://rover-hub.taiseiue.jp/command");
            hub.DirectionReceived += async (sender, direction) =>
            {
                rawText = direction.ToString();
                await Rover.Move(direction);
            };
            await hub.SetDirectionAsync(MotorDirection.Stop);
            rawText = "Connection OK.";
        }
        catch (Exception ex)
        {
            rawText = $"Error: {ex.Message}";
        }

        timer = new Timer(10000);
        timer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(StateHasChanged);
            //await camera.CapturePhotoAsync();
        };
        //timer.Start();
    }
}